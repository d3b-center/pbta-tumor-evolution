---
title: "Update histolgies file"
author: 'Antonia Chroni <chronia@chop.edu> for D3B'
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---


# Background
This is to update histologies file for the `pbta-tumor-evolution` project by: (1) adding `plot_group` column and (2) using `2023-11-13_histologies-base` in which approx. 150 RNA samples of poor quality have been removed. 

This module will be removed once v13 is released.

# Usage
To run the Rscript from the command line sequentially, use:

```
Rscript -e "rmarkdown::render('01_update_histologies.Rmd', clean = TRUE)"
```

# Set up
```{r load-library}
suppressPackageStartupMessages({
  library(tidyverse)
})
```

## Directories and File Inputs/Outputs
```{r set-dir-and-file-names}
# Detect the ".git" folder -- this will be in the project root directory.
# Use this as the root directory to ensure proper sourcing of functions no
# matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "update-histologies-temp")
input_dir <- file.path(analysis_dir, "input")

# Inputs
hist_file <- file.path(input_dir, "2023-11-13_histologies-base.tsv")
plot_mapping_file <- file.path(input_dir, "plot-mapping - plot-mapping.tsv")

# File path to results directory
results_dir <-
  file.path(analysis_dir, "results")
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
```

# Read in data and process Data
```{r read-process-data, echo=TRUE}
hist_df <- readr::read_tsv(hist_file, guess_max = 100000, show_col_types = FALSE)

df <- readr::read_tsv(plot_mapping_file, guess_max = 100000, show_col_types = FALSE) %>% 
  select(broad_histology, cancer_group, plot_group) %>% 
  left_join(hist_df, by = "broad_histology", relationship = "many-to-many") %>% 
  write_tsv(file.path(results_dir, "histologies_2023_11_15.tsv")) 
```


```{r}
sessionInfo()
```
  