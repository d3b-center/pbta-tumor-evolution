---
title: "Classification of Variants across paired longitudinal samples in the PBTA Cohort"
author: 'Antonia Chroni <chronia@chop.edu> and Jo Lynne Rokita <rokita@chop.edu> for D3B'
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---

# Set up
```{r load-library}
suppressPackageStartupMessages({
  library(tidyverse)
})
```

## Directories and File Inputs/Outputs
```{r set-dir-and-file-names}
# Detect the ".git" folder -- this will be in the project root directory
# Use this as the root directory to ensure proper sourcing of functions 
# no matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "tmb-vaf-longitudinal")
results_dir <- file.path(analysis_dir, "results")
input_dir <- file.path(analysis_dir, "input")
files_dir <- file.path(root_dir, "analyses", "sample-distribution-analysis", "results")

# Input files
genomic_paired_file <- file.path(files_dir, "genomic_assays_matched_time_points_extended.tsv") 
tmb_vaf_file <- file.path(results_dir, "tmb_vaf_genomic.tsv")
palette_file <- file.path(root_dir, "figures", "palettes", "oncoprint_color_palette.tsv")

# File path to plot directory
plots_dir <-
  file.path(analysis_dir, "plots")
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}

source(paste0(root_dir, "/figures/scripts/theme.R"))
```

## Read in data and process
```{r load-process-inputs}
tmb_vaf_df <- readr::read_tsv(tmb_vaf_file, guess_max = 100000, show_col_types = FALSE) %>% 
  filter(!tmb >= 10) %>% 
  select(Kids_First_Biospecimen_ID, Variant_Classification, gene_protein, mutation_count,	region_size, tmb, VAF)

genomic_paired_df <- readr::read_tsv(genomic_paired_file, guess_max = 100000, show_col_types = FALSE) %>% 
  left_join(tmb_vaf_df, by = c("Kids_First_Biospecimen_ID"))

# Which patient samples don't have TMB?
#genomic_paired_df %>% 
#  filter(is.na(tmb)) %>% 
#  unique() %>% 
#  regulartable() %>%
#  fontsize(size = 12, part = "all")

# Vector to order timepoints
td_order <- c("Diagnosis", "Progressive", "Recurrence", "Deceased", "Second Malignancy", "Unavailable")

df <- genomic_paired_df %>% 
  filter(!is.na(tmb)) %>% 
  mutate(cgGFAC = case_when(grepl("High-grade glioma", cancer_group) ~ "HGG",
                            grepl("Diffuse midline glioma", cancer_group) ~ "DIPG",
                            grepl("Medulloblastoma", cancer_group) ~ "Medulloblastoma",
                            grepl("Atypical Teratoid Rhabdoid Tumor", cancer_group) ~ "ATRT",
                            grepl("Low-grade glioma", cancer_group) ~ "LGG",
                            grepl("Ependymoma", cancer_group) ~ "Ependymoma",
                            grepl("Chordoma", cancer_group) ~ "Chordoma",
                            TRUE ~ "Other"),
         td_cgGFAC = case_when(grepl("Deceased", tumor_descriptor) ~ "xDeceased",
                                      TRUE ~ tumor_descriptor))


# Let's count #samples per cancer groups and timepoints 
timepoint_cg_n_df <- df %>% 
  count(cancer_group, tumor_descriptor) %>% 
  dplyr::mutate(tumor_descriptor_cg_n = glue::glue("{cancer_group}_{tumor_descriptor}  (N={n})")) %>% 
  dplyr::rename(timepoint_cg_n = n) 

# Let's count #samples per cancer groups and timepoints 
timepoint_cgGFAC_n_df <- df %>% 
  count(cgGFAC, td_cgGFAC) %>% 
  dplyr::mutate(tumor_descriptor_cgGFAC_n = glue::glue("{cgGFAC}_{td_cgGFAC}  (N={n})")) %>% 
  dplyr::rename(timepoint_cgGFAC_n = n) 

# Create df to use for plots
df_plot <- df %>% 
  left_join(timepoint_cg_n_df, by = c("tumor_descriptor", "cancer_group")) %>%
  #filter(!timepoint_n <= 2) 
  left_join(timepoint_cgGFAC_n_df, by = c("td_cgGFAC", "cgGFAC")) %>% 
  mutate(tumor_descriptor = factor(tumor_descriptor),
         tumor_descriptor = fct_relevel(tumor_descriptor, td_order))
        
``` 


```{r define-parameters-for-plots}
# Read color palette
palette_df <- readr::read_tsv(palette_file, guess_max = 100000, show_col_types = FALSE) 

# Define and order palette
palette <- palette_df$hex_codes
names(palette) <- palette_df$Variant_Classification

# Define label for plots
Alteration_type <- df_plot$Variant_Classification

# Define ylim
ylim <- max(df_plot$tmb)
```

# What type of alterations we observe per tumor descriptor?

```{r plot-timepoint, fig.width = 15, fig.height = 8, fig.fullwidth = TRUE}
# Create bxp
print(ggpubr::ggboxplot(df_plot, 
                        x = "tumor_descriptor", 
                        y = "tmb", 
                        color = "Variant_Classification",
                        palette = palette) +
        theme_Publication() + 
        scale_y_continuous(limits = c(0, ylim)) +
        ylab("TMB") +
        xlab("Timepoint") +
        theme(axis.text.x = element_text(angle = 90)))

# Save the plot
ggsave(filename = "Alteration_type_timepoints.pdf", 
       path = plots_dir, 
       width = 15, 
       height = 8, 
       device = "pdf", 
       useDingbats = FALSE)
```


# What type of alterations we observe per tumor descriptor in each cancer group?

```{r plot-cancer-group, fig.width = 25, fig.height = 18, fig.fullwidth = TRUE}
# Create bxp
print(ggpubr::ggboxplot(df_plot, 
                        x = "tumor_descriptor", 
                        y = "tmb", 
                        color = "Variant_Classification",
                        palette = palette) +
        facet_wrap(~cancer_group) +
        theme_Publication() + 
        ylab("TMB") +
        xlab("Timepoint") +
        scale_y_continuous(limits = c(0, ylim)) +
        theme(axis.text.x = element_text(angle = 90)))

# Save the plot
ggsave(filename = "Alteration_type_cancer_group.pdf", 
       path = plots_dir, 
       width = 25, 
       height = 18, 
       device = "pdf", 
       useDingbats = FALSE)
```


# What type of alterations we observe per tumor descriptor in each cancer group defined by cgGFAC?

```{r plot-cgGFAC-n, fig.width = 18, fig.height = 12, fig.fullwidth = TRUE}
df_plot_cgGFAC <- df_plot %>% 
  arrange(tumor_descriptor_cgGFAC_n)
  #mutate(tumor_descriptor_cgGFAC_n = factor(tumor_descriptor_cgGFAC_n)) 

#df_plot_cgGFAC$tumor_descriptor_cgGFAC_n %>% levels()

# Create bxp
print(ggpubr::ggboxplot(df_plot_cgGFAC, 
                        x = "tumor_descriptor_cgGFAC_n", 
                        y = "tmb", 
                        color = "Variant_Classification",
                        palette = palette) +
        #facet_wrap(~cgGFAC) +
        theme_Publication() + 
        ylab("TMB") +
        xlab("Timepoint") +
        scale_y_continuous(limits = c(0, ylim)) +
        theme(axis.text.x = element_text(angle = 90)))

# Save the plot
ggsave(filename = "Alteration_type_cgGFAC.pdf", 
       path = plots_dir, 
       width = 18, 
       height = 12, 
       device = "pdf", 
       useDingbats = FALSE)

```


```{r plot-cgGFAC-n-individual-plots, fig.width = 8, fig.height = 6, fig.fullwidth = TRUE}
cgGFAC_id <- as.character(unique(df_plot_cgGFAC$cgGFAC))
cgGFAC_id

# Loop through variable
for (i in seq_along(cgGFAC_id)){
  print(i)
  df_sub <- df_plot_cgGFAC %>%
      filter(cgGFAC == cgGFAC_id[i])

  
   # Create bxp
  print(ggpubr::ggboxplot(df_sub, 
                        x = "tumor_descriptor_cgGFAC_n", 
                        y = "tmb", 
                        color = "Variant_Classification",
                        palette = palette) +
        theme_Publication() + 
        ylab("TMB") +
        labs(title = paste(cg)) +
        scale_y_continuous(limits = c(0, ylim)) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))
}
```

# What type of alterations we observe per tumor descriptor in each cancer group (add _n))?
 

```{r plot-n, fig.width = 8, fig.height = 6, fig.fullwidth = TRUE}
cg <- as.character(unique(df_plot$cancer_group))
cg

# Loop through variable
for (i in seq_along(cg)){
  print(i)
  df_sub <- df_plot %>%
      filter(cancer_group == cg[i])
  
  # Create bxp
  print(ggpubr::ggboxplot(df_sub, 
                        x = "tumor_descriptor_cg_n", 
                        y = "tmb", 
                        color = "Variant_Classification",
                        palette = palette) +
        theme_Publication() + 
        ylab("TMB") +
        xlab("Timepoint") +
        labs(title = paste(cg)) +
        scale_y_continuous(limits = c(0, ylim)) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))

  # Save the plot
  #name <- paste0(cg[i], "-Alteration_type_cancer_group.pdf")
  #ggsave(filename = name, 
  #       path = plots_dir, 
  #       width = 12, 
  #       height = 8, 
  #       device = "pdf", 
  #       useDingbats = FALSE)
}
```


# What type of alterations we observe per tumor descriptor in each cancer group and timepoint model?

```{r plot-timepoint-model, fig.width = 25, fig.height = 18, fig.fullwidth = TRUE}
tm <- as.character(unique(df_plot$timepoints_models))
tm

# Loop through variable
for (i in seq_along(tm)){
  print(i)
  df_sub <- df_plot %>%
      filter(timepoints_models == tm[i])
  
  # Create bxp
  print(ggpubr::ggboxplot(df_sub, 
                        x = "tumor_descriptor", 
                        y = "tmb", 
                        color = "Variant_Classification",
                        palette = palette) +
        facet_wrap(~cancer_group) +
        theme_Publication() +
        ylab("TMB") +
        xlab("Timepoint") +
        scale_y_continuous(limits = c(0, ylim)) +
        theme(axis.text.x = element_text(angle = 90)))

   # Save the plot
   #name <- paste0(timepoints_models[i], "-Alteration_type_cancer_group.pdf")
   #ggsave(filename = name, 
   #    path = plots_dir, 
   #    width = 12, 
   #    height = 8, 
   #   device = "pdf", 
   #   useDingbats = FALSE)
}
```


```{r echo=TRUE}
sessionInfo()
```
