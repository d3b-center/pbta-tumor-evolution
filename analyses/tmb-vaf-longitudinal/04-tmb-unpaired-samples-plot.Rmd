---
title: "TMB of tumors across unpaired longitudinal samples in the PBTA Cohort"
author: 'Antonia Chroni <chronia@chop.edu> and Jo Lynne Rokita <rokita@chop.edu> for D3B'
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---

#### Tumor evolution project 

### Data used 
In this notebook, we are using the `pbta.tsv` file generated by the `sample-distribution-analysis` module.

# Set up
```{r load-library}
suppressPackageStartupMessages({
  library(tidyverse)
  library(rstatix)
  library(ggpubr)
})
```

## Directories and File Inputs/Outputs
```{r set-dir-and-file-names}
# Detect the ".git" folder -- this will be in the project root directory
# Use this as the root directory to ensure proper sourcing of functions 
# no matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "tmb-vaf-longitudinal")
input_dir <- file.path(analysis_dir, "input")
files_dir <- file.path(root_dir, "analyses", "sample-distribution-analysis", "results")

# Input files
pbta_file <- file.path(files_dir, "pbta.tsv") # file from add-sample-distribution module
tmb_file <- file.path(input_dir, "snv-mutation-tmb-coding.tsv")
palette_file <- file.path(root_dir, "figures", "palettes", "tumor_descriptor_color_palette.tsv")

# File path to plot directory
plots_dir <-
  file.path(analysis_dir, "plots")
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}

# File path to results directory
results_dir <-
  file.path(analysis_dir, "results")
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

source(paste0(root_dir, "/figures/scripts/theme.R"))
```

## Read in data and process
```{r load-process-inputs}
# Make this reproducible
set.seed(2023)

# Define timepoints
timepoints = c("Diagnosis", "Progressive", "Recurrence", "Deceased", "Second Malignancy", "Unavailable")

# Read in tmb file and remove hypermutant samples
tmb <- readr::read_tsv(tmb_file, guess_max = 100000, show_col_types = FALSE) %>%
  filter(!tmb >= 10) %>% 
  dplyr::rename(Kids_First_Biospecimen_ID = Tumor_Sample_Barcode) # change name of the biospecimen to match the one from the histologies file

# Read in pbta file and create df
df <- readr::read_tsv(pbta_file, guess_max = 100000, show_col_types = FALSE) %>%
  filter(!(experimental_strategy == "RNA-Seq"),
         !(tumor_descriptor == "Unavailable")) %>% # these are 2 samples
  left_join(tmb, by = c("Kids_First_Biospecimen_ID", "experimental_strategy")) %>%
  select(Kids_First_Participant_ID, Kids_First_Biospecimen_ID, tumor_descriptor,
         broad_histology, match_id_DNA, experimental_strategy, 
         cg_multiple, cg_id, cancer_group, short_histology, tmb, mutation_count, DNA) %>%
  dplyr::mutate(cgGFAC = case_when(grepl("High-grade glioma", cg_id) ~ "HGG", 
                                   grepl("Diffuse midline glioma", cg_id) ~ "DMG",
                                   grepl("Atypical Teratoid Rhabdoid Tumor", cg_id) ~ "ATRT",
                                   grepl("Low-grade glioma", cg_id) ~ "LGG",
                                   TRUE ~ "Other"),
                 td_cgGFAC = case_when(grepl("Deceased", tumor_descriptor) ~ "xDeceased", 
                                       TRUE ~ tumor_descriptor),
                 log10_tmb = abs(log10(tmb))) %>% 
  distinct(match_id_DNA, .keep_all = TRUE) %>% # keep only one bs_sample per genomic assay (WGS/WXS)
  filter(!is.na(tmb))

# How many samples per Timepoint?
print(df %>% count(tumor_descriptor) %>% arrange(desc(n)))

# How many samples per cancer group?
print(df %>% count(cg_id) %>% arrange(desc(n)))

# How many samples per Timepoint and cancer type?
# rename(count(df, tumor_descriptor, cg_id), Freq = n)

# How many cases with unpaired longitudinal samples?
no_samples <- length(unique(df$Kids_First_Participant_ID))

# Let's count #samples per cancer groups and timepoints 
timepoint_cg_n_df <- df %>% 
  count(cg_id, tumor_descriptor) %>% 
  dplyr::mutate(tumor_descriptor_cg_n = glue::glue("{cg_id}_{tumor_descriptor}  (N={n})")) %>% 
  dplyr::rename(timepoint_cg_n = n) 

# Let's count #samples per cancer groups and timepoints 
timepoint_cgGFAC_n_df <- df %>% 
  count(cgGFAC, td_cgGFAC) %>% 
  dplyr::mutate(tumor_descriptor_cgGFAC_n = glue::glue("{cgGFAC}_{td_cgGFAC}  (N={n})")) %>% 
  dplyr::rename(timepoint_cgGFAC_n = n) 

# Summarize timepoints per cancer groups
# We will summarize cancer groups with single timepoints as "Other" 
timepoint_sum <- df %>%
  distinct(match_id_DNA, .keep_all = TRUE) %>%
  group_by(cg_id) %>%
  arrange(tumor_descriptor) %>%
  summarise(tumor_descriptor_sum = str_c(tumor_descriptor, collapse = "-")) 

# Create df to use for plots
df_plot <- df %>% 
  left_join(timepoint_cg_n_df, by = c("tumor_descriptor", "cg_id")) %>%
  filter(!tumor_descriptor_cg_n <= 2) %>% # remove if total #samples per timepoint is less than 2

  left_join(timepoint_cgGFAC_n_df, by = c("td_cgGFAC", "cgGFAC")) %>% 
  filter(!timepoint_cgGFAC_n <= 2) %>% # remove if total #samples per timepoint is less than 2

  left_join(timepoint_sum, by = c("cg_id")) %>%
  filter(!tumor_descriptor_sum %in% timepoints,
         !tumor_descriptor_sum %in% c("Diagnosis-Diagnosis", 
                                      "Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis",
                                      "Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis",
                                      "Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis"
                                      )) %>% # remove cancer groups with single timepoints
  mutate(cg_id_sum = replace_na(cg_id, "Other"),
         tumor_descriptor = factor(tumor_descriptor),
         tumor_descriptor = fct_relevel(tumor_descriptor, timepoints))
``` 


## How many patient samples in the unpaired longitudinal data?
There are `r no_samples` samples in total.

# All unpaired samples
We are interested in how TMB changes over the time in all PBTA samples (unpaired samples).

```{r define-parameters-for-plots}
# Read color palette
palette_df <- readr::read_tsv(palette_file, guess_max = 100000, show_col_types = FALSE) %>% 
  mutate(tumor_descriptor = color_names)

# Define and order palette
palette <- palette_df$hex_codes
names(palette) <- palette_df$tumor_descriptor

# Define label for plots
Timepoint <- df_plot$tumor_descriptor

# Define ylim
ylim <- max(df_plot$tmb)
log10_ylim <- max(df_plot$log10_tmb)
```

```{r plot-total, fig.width = 10, fig.height = 5, fig.fullwidth = TRUE}
print(ggplot(df_plot, aes(tumor_descriptor, tmb, color = Timepoint)) + 
        geom_jitter(width = 0.2, alpha = 0.5, size = 1.5) + 
        # light guiding line representing 0 exposure
        geom_hline(yintercept = 0, size = 0.15) + 
        scale_color_manual(values = palette, 
                           breaks = sort(names(palette))) +
        stat_summary(color = "black", size = 0.3) + 
        labs(x = "Tumor descriptor",
             y = "TMB") +
        theme_Publication() +
        scale_y_continuous(limits = c(0, ylim)) +
        theme(axis.text.x = element_text(angle = 90)))

# Save the plot
ggsave(filename = "TMB-unpaired-longitudinal.pdf",
       path = plots_dir, 
       width = 10, 
       height = 5, 
       device = "pdf", 
       useDingbats = FALSE)
```


# All unpaired samples across cancer types

```{r plot-cg-id-sum, fig.width = 25, fig.height = 20, fig.fullwidth = TRUE}
print(ggplot(df_plot, aes(tumor_descriptor, log10_tmb, color = Timepoint)) + 
        geom_jitter(width = 0.2, alpha = 0.5, size = 1.5) + 
        # light guiding line representing 0 exposure
        geom_hline(yintercept = 0, size = 0.15) + 
        scale_color_manual(values = palette, 
                           breaks = sort(names(palette))) +
        stat_summary(color = "black", size = 0.3) + 
        ggplot2::facet_wrap(~cg_id_sum, nrow = 8) +
        labs(x = "Tumor descriptor",
             y = "log10TMB") +
        theme_Publication() +
        scale_y_continuous(limits = c(0, log10_ylim)) +
        theme(axis.text.x = element_text(angle = 90)))

# Save the plot
ggsave(filename = "TMB-unpaired-longitudinal-cg-id-sum.pdf", 
       path = plots_dir, 
       width = 25, 
       height = 20, 
       device = "pdf", 
       useDingbats = FALSE)
```

We observe that majority of samples are High- and Low-grade gliomas as well as Ependymoma, so we will classify accordingly (versus any other cancer types).

# All unpaired samples across cancer types summarized

```{r cancer-group-sum, fig.width = 12, fig.height = 6, fig.fullwidth = TRUE}
df_plot_cgGFAC <- df_plot %>% 
  arrange(tumor_descriptor_cgGFAC_n)
  #mutate(tumor_descriptor_cgGFAC_n = factor(tumor_descriptor_cgGFAC_n)) 

# Define label for plots
Timepoint_cancer <- df_plot_cgGFAC$tumor_descriptor

```

# Summary statistics for Timepoints and cancer types
Considering the inequalities in the sampling effort for each timepoint, let's explore whether the sampling size affects the observed patterns, e.g., indication of Progressive and Recurrence having higer TMB compared to Diagnosis for High-grade glioma patients.

```{r summary-statistics, fig.width = 12, fig.height = 6, fig.fullwidth = TRUE}
# Inspect some random rows of the data by groups
set.seed(2023)
df_plot_cgGFAC %>% 
  select(cgGFAC, tumor_descriptor_cgGFAC_n, log10_tmb) %>% 
  sample_n_by(cgGFAC, tumor_descriptor_cgGFAC_n, log10_tmb, size = 1) 

# Compute some summary statistics (mean and sd) by groups:
stat.summary <- df_plot_cgGFAC %>%
  group_by(cgGFAC, tumor_descriptor_cgGFAC_n) %>%
  get_summary_stats(log10_tmb, type = "mean_sd") %>% 
  write_tsv(file.path(results_dir, "stat_summary.tsv"))

# Pairwise comparisons between time points at each group levels
# Paired t-test is used because we have repeated measures by time
stat.test <- df_plot_cgGFAC %>%
  group_by(cgGFAC) %>%
  pairwise_t_test(log10_tmb ~ tumor_descriptor_cgGFAC_n, 
                  paired = FALSE, 
                  p.adjust.method = "bonferroni") %>% 
  write_tsv(file.path(results_dir, "stat_test.tsv"))

# Add statistical test p-values
stat.test <- stat.test %>% add_xy_position(x = "tumor_descriptor_cgGFAC_n")

# Create bxp
print(ggboxplot(df_plot_cgGFAC,
                x = "tumor_descriptor_cgGFAC_n",
                y = "log10_tmb",
                color = "tumor_descriptor",
                palette = palette) +
        theme_Publication() + 
        theme(axis.text.x = element_text(angle = 90)) +
        stat_pvalue_manual(stat.test,
                           label = "{p.signif}",
                           hide.ns = "p",
                           y.position = "y.position") +
        scale_y_continuous(limits = c(0, 2)))

# Save the plot
ggsave(filename = "TMB-Bxp-stat-test.pdf", 
       path = plots_dir, 
       width = 12, 
       height = 6, 
       device = "pdf", 
       useDingbats = FALSE)
```

```{r echo=TRUE}
sessionInfo()
```
