---
title: "TMB of tumors across unpaired longitudinal samples in the PBTA Cohort"
author: 'Antonia Chroni <chronia@chop.edu> and Jo Lynne Rokita <rokita@chop.edu> for D3B'
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---

#### Tumor evolution project 

### Data used 
In this notebook, we are using the `pbta.tsv` file generated by the `sample-distribution-analysis` module.

# Set up
```{r load-library}
suppressPackageStartupMessages({
  library(tidyverse)
  library(rstatix)
  library(ggpubr)
})
```

## Directories and File Inputs/Outputs
```{r set-dir-and-file-names}
# Detect the ".git" folder -- this will be in the project root directory
# Use this as the root directory to ensure proper sourcing of functions 
# no matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "tmb-vaf-longitudinal")
input_dir <- file.path(analysis_dir, "input")
files_dir <- file.path(root_dir, "analyses", "sample-distribution-analysis", "results")

# Input files
pbta_file <- file.path(files_dir, "pbta.tsv") # file from add-sample-distribution module
tmb_file <- file.path(input_dir, "snv-mutation-tmb-coding.tsv")
palette_file <- file.path(root_dir, "figures", "palettes", "tumor_descriptor_color_palette.tsv")

# File path to plot directory
plots_dir <-
  file.path(analysis_dir, "plots")
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}

source(paste0(root_dir, "/figures/scripts/theme.R"))
```

## Read in data and process
```{r load-process-inputs}
# Make this reproducible
set.seed(2023)

# Define timepoints
timepoints = c("Diagnosis", "Progressive", "Recurrence", "Deceased", "Second Malignancy", "Unavailable")

# Read in tmb file and remove hypermutant samples
tmb <- readr::read_tsv(tmb_file, guess_max = 100000, show_col_types = FALSE) %>%
  filter(!tmb >= 10) %>% 
  dplyr::rename(Kids_First_Biospecimen_ID = Tumor_Sample_Barcode) # change name of the biospecimen to match the one from the histologies file

# Read in pbta file and create df
df <- readr::read_tsv(pbta_file, guess_max = 100000, show_col_types = FALSE) %>%
  filter(!(experimental_strategy == "RNA-Seq"),
         !(tumor_descriptor == "Unavailable")) %>% # these are 2 samples
  left_join(tmb, by = c("Kids_First_Biospecimen_ID", "experimental_strategy")) %>%
  select(Kids_First_Participant_ID, Kids_First_Biospecimen_ID, tumor_descriptor,
         broad_histology, match_id_DNA, experimental_strategy, 
         cancer_group, short_histology, tmb, mutation_count, DNA) %>%
  dplyr:::mutate(short_histology_sum = ifelse(short_histology == "HGAT", "HGG",
                                              ifelse(short_histology == "LGAT", "LGG", 
                                                     ifelse(short_histology == "Ependymoma", "Ependymoma", 
                                                            ifelse(short_histology == "Medulloblastoma", "Medulloblastoma", 
                                                                   ifelse(short_histology == "ATRT", "ATRT", "Other"))))),
                 log10_tmb = abs(log10(tmb)),
                 tumor_descriptor = factor(tumor_descriptor),
                 tumor_descriptor = fct_relevel(tumor_descriptor, timepoints)) %>% 
  distinct(match_id_DNA, .keep_all = TRUE) %>% # keep only one bs_sample per genomic assay (WGS/WXS)
  filter(!is.na(tmb))

# How many samples per Timepoint?
print(df %>% count(tumor_descriptor) %>% arrange(desc(n)))

# How many samples per cancer group?
print(df %>% count(cancer_group) %>% arrange(desc(n)))

#table = df %>% count(cancer_group) %>%
#  write_tsv(file.path(results_dir, "cancer_group_count.tsv"))

# How many samples per short_histology_sum?
# print(df %>% count(short_histology_sum) %>% arrange(desc(n)))

# How many samples per Timepoint and cancer type?
rename(count(df, tumor_descriptor, cancer_group), Freq = n)

# How many cases with unpaired longitudinal samples?
no_samples <- length(unique(df$Kids_First_Participant_ID))

# Let's count #samples per cancer groups and timepoints 
timepoint_n_df <- df %>% 
  count(cancer_group, tumor_descriptor) %>% 
  dplyr::mutate(tumor_descriptor_n = glue::glue("{tumor_descriptor} (N={n})")) %>% 
  dplyr::rename(timepoint_n = n) 

# Summarize timepoints per cancer groups
# We will summarize cancer groups with single timepoints as "Other" 
timepoint_sum <- df %>%
  distinct(match_id_DNA, .keep_all = TRUE) %>%
  group_by(cancer_group) %>%
  arrange(tumor_descriptor) %>%
  summarise(tumor_descriptor_sum = str_c(tumor_descriptor, collapse = "-")) 

df_plot <- df %>% 
  left_join(timepoint_n_df, by = c("tumor_descriptor", "cancer_group")) %>%
  filter(!timepoint_n <= 2) %>% # remove if total samples per timepoint is less than 2
  left_join(timepoint_sum, by = c("cancer_group")) %>%
  filter(!tumor_descriptor_sum %in% timepoints,
         !tumor_descriptor_sum %in% c("Diagnosis-Diagnosis", 
                                      "Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis",
                                      "Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis",
                                      "Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis-Diagnosis"
                                      )) %>% # remove cancer groups with single timepoints
 # TODO: not sure how to make lines 109-113 reproducible

  mutate(cancer_group_sum = replace_na(cancer_group, "Other"))
``` 


## How many patient samples in the unpaired longitudinal data?
There are `r no_samples` samples in total.

# All unpaired samples
We are interested in how TMB changes over the time in all PBTA samples (unpaired samples).

```{r define-parameters-for-plots}
# Read color palette
palette_df <- readr::read_tsv(palette_file, guess_max = 100000, show_col_types = FALSE) %>% 
  mutate(tumor_descriptor = color_names)

# Define and order palette
palette <- palette_df$hex_codes
names(palette) <- palette_df$tumor_descriptor

# Define label for plots
Timepoint <- df_plot$tumor_descriptor

# Define ylim
ylim <- max(df_plot$tmb)
```

```{r plot-total, fig.width = 10, fig.height = 5, fig.fullwidth = TRUE}
print(df_plot %>% 
        ggplot2::ggplot() + 
        ggplot2::aes(x = tumor_descriptor, 
                     y = tmb,
                     color = Timepoint) + 
        ggplot2::geom_jitter(width = 0.2, alpha = 0.5, size = 1.5) + 
        # light guiding line representing 0 exposure
        ggplot2::geom_hline(yintercept = 0, size = 0.15) + 
        ggplot2::scale_color_manual(values = palette, 
                                    breaks = sort(names(palette))) +
        ggplot2::stat_summary(color = "black", size = 0.3) + 
        ggplot2::labs(x = "Tumor descriptor",
                      y = "TMB") +
        theme_Publication() +
        scale_y_continuous(limits = c(0, ylim)) +
        theme(axis.text.x = element_text(angle = 90)))

# Save the plot
ggsave(filename = "TMB-unpaired-longitudinal-samples.pdf",
       path = plots_dir, 
       width = 10, 
       height = 5, 
       device = "pdf", 
       useDingbats = FALSE)
```


# All unpaired samples across cancer types
We will use the `cancer_group` column to display TMB differences across cancer types.

```{r plot-cancer-group, fig.width = 25, fig.height = 20, fig.fullwidth = TRUE}
print(df_plot %>%
        ggplot2::ggplot() + 
        ggplot2::aes(x = tumor_descriptor, 
                     y = tmb,
                     color = Timepoint) + 
        ggplot2::geom_jitter(width = 0.2, alpha = 0.5, size = 1.5) + 
        # light guiding line representing 0 exposure
        ggplot2::geom_hline(yintercept = 0, size = 0.15) + 
        ggplot2::scale_color_manual(values = palette, 
                                    breaks = sort(names(palette))) +
        ggplot2::stat_summary(color = "black", size = 0.3) + 
        ggplot2::facet_wrap(~cancer_group, nrow = 8) +
        ggplot2::labs(x = "Tumor descriptor",
                      y = "TMB") +
        theme_Publication() + 
        theme(axis.text.x = element_text(angle = 90)) +
        scale_y_continuous(limits = c(0, ylim)))

# Save the plot
ggsave(filename = "TMB-unpaired-longitudinal-samples-cancer-type.pdf", 
       path = plots_dir, 
       width = 25, 
       height = 20, 
       device = "pdf", 
       useDingbats = FALSE)
```

```{r plot-cancer-group-sum, fig.width = 25, fig.height = 20, fig.fullwidth = TRUE}
print(df_plot %>%
        ggplot2::ggplot() + 
        ggplot2::aes(x = tumor_descriptor, 
                     y = tmb,
                     color = Timepoint) + 
        ggplot2::geom_jitter(width = 0.2, alpha = 0.5, size = 1.5) + 
        # light guiding line representing 0 exposure
        ggplot2::geom_hline(yintercept = 0, size = 0.15) + 
        ggplot2::scale_color_manual(values = palette, 
                                    breaks = sort(names(palette))) +
        ggplot2::stat_summary(color = "black", size = 0.3) + 
        ggplot2::facet_wrap(~cancer_group_sum, nrow = 8) +
        ggplot2::labs(x = "Tumor descriptor",
                      y = "TMB") +
        theme_Publication() + 
        theme(axis.text.x = element_text(angle = 90)) +
        scale_y_continuous(limits = c(0, ylim)))

# Save the plot
ggsave(filename = "TMB-unpaired-longitudinal-samples-cancer-type-sum.pdf", 
       path = plots_dir, 
       width = 25, 
       height = 20, 
       device = "pdf", 
       useDingbats = FALSE)
```

We observe that majority of samples are High- and Low-grade gliomas as well as Ependymoma, so we will classify accordingly (versus any other cancer types).

# All unpaired samples across cancer types summarized

```{r cancer-group-sum, fig.width = 12, fig.height = 6, fig.fullwidth = TRUE}
# Let's count and remove any cancer types and timepoints with less than 2 samples therein
tumor_descriptor_cancer_n_df <- df_plot %>% 
  count(short_histology_sum, tumor_descriptor) %>% 
  dplyr::mutate(tumor_descriptor_cancer_n = glue::glue("{short_histology_sum}_{tumor_descriptor}  (N={n})")) %>% 
  dplyr::rename(histology_n = n)

df_plot_cancer <- df_plot %>% 
  left_join(tumor_descriptor_cancer_n_df, by = c("tumor_descriptor", "short_histology_sum")) %>%
  filter(!histology_n <= 2) # remove if total number of values per group is less than 2

# Define label for plots
Timepoint_cancer <- df_plot_cancer$tumor_descriptor

# Define ylim
ylim_cancer <- max(df_plot_cancer$tmb)

# Plot by using tumor_descriptor_cancer_n
# Let's order first x axis 
#TODO: To make the f reproducible
f = c("ATRT_Diagnosis  (N=48)", "ATRT_Progressive  (N=10)", "ATRT_Recurrence  (N=3)", "ATRT_Deceased  (N=4)",
  "Ependymoma_Diagnosis  (N=113)", "Ependymoma_Progressive  (N=20)" , "Ependymoma_Recurrence  (N=24)", "Ependymoma_Deceased  (N=7)",
      "HGG_Diagnosis  (N=235)", "HGG_Progressive  (N=22)", "HGG_Recurrence  (N=15)", "HGG_Deceased  (N=72)", "HGG_Second Malignancy  (N=5)",
      "LGG_Diagnosis  (N=405)" , "LGG_Progressive  (N=61)", "LGG_Recurrence  (N=25)", "LGG_Deceased  (N=7)", "LGG_Second Malignancy  (N=4)" ,
      "Medulloblastoma_Diagnosis  (N=217)", "Medulloblastoma_Progressive  (N=6)", "Medulloblastoma_Recurrence  (N=6)" , "Medulloblastoma_Deceased  (N=6)",
      "Other_Diagnosis  (N=538)", "Other_Progressive  (N=89)", "Other_Recurrence  (N=80)", "Other_Deceased  (N=8)")

df_plot_cancer <- df_plot_cancer %>% 
  mutate(tumor_descriptor_cancer_n = factor(tumor_descriptor_cancer_n),
                 tumor_descriptor_cancer_n = fct_relevel(tumor_descriptor_cancer_n, f))
```

# Summary statistics for Timepoints and cancer types
Considering the inequalities in the sampling effort for each timepoint, let's explore whether the sampling size affects the observed patterns, e.g., indication of Progressive and Recurrence having higer TMB compared to Diagnosis for High-grade glioma patients.

```{r summary-statistics, fig.width = 12, fig.height = 6, fig.fullwidth = TRUE}
# Inspect some random rows of the data by groups
set.seed(2023)
df_plot_cancer %>% 
  select(short_histology_sum, tumor_descriptor_cancer_n, tmb, log10_tmb) %>% 
  sample_n_by(short_histology_sum, tumor_descriptor_cancer_n, tmb, size = 1)

# Compute some summary statistics (mean and sd) by groups:
stat.summary <- df_plot_cancer %>%
  group_by(short_histology_sum, tumor_descriptor_cancer_n) %>%
  get_summary_stats(tmb, type = "mean_sd")
stat.summary

# Pairwise comparisons between time points at each group levels
# Paired t-test is used because we have repeated measures by time
stat.test <- df_plot_cancer %>%
  group_by(short_histology_sum) %>%
  pairwise_t_test(log10_tmb ~ tumor_descriptor_cancer_n, 
                  paired = FALSE, 
                  p.adjust.method = "bonferroni")
stat.test

# Add statistical test p-values
stat.test <- stat.test %>% add_xy_position(x = "tumor_descriptor_cancer_n")

# Create bxp
print(ggboxplot(df_plot_cancer,
                x = "tumor_descriptor_cancer_n",
                y = "log10_tmb",
                color = "tumor_descriptor",
                palette = palette) +
        theme_Publication() + 
        theme(axis.text.x = element_text(angle = 90)) +
        stat_pvalue_manual(stat.test, label = "p.adj.signif",
                           step.increase = 0.08, hide.ns = TRUE, tip.length = 0))

# Save the plot
ggsave(filename = "TMB-Bxp-stat-test.pdf", 
       path = plots_dir, 
       width = 12, 
       height = 6, 
       device = "pdf", 
       useDingbats = FALSE)

# This code was inspired by the following:
# HOW TO PERFORM MULTIPLE PAIRED T-TESTS IN R
# https://www.datanovia.com/en/blog/how-to-perform-multiple-paired-t-tests-in-r/

```

```{r echo=TRUE}
sessionInfo()
```
