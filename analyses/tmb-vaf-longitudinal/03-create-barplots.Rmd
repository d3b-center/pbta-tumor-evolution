---
title: "Create TMB barplots of tumors across multiple timepoints for thr autopsy samples in the PBTA Cohort"
author: "Antonia Chroni <chronia@chop.edu> for D3B"
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---

#### Tumor evolution project 

### Data used 
In this notebook, we are using the `tmb_genomic.tsv` file generated from the `01-preprocess-data.Rmd` script.

# Set up
```{r load-library}
suppressPackageStartupMessages({
  library(tidyverse)
})
```

# Directories and File Inputs/Outputs
```{r set-dir-and-file-names}
# Detect the ".git" folder. This will be in the project root directory.
# Use this as the root directory to ensure proper sourcing of functions
# no matter where this is called from.
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
scratch_dir <- file.path(root_dir, "scratch")
analysis_dir <- file.path(root_dir, "analyses", "tmb-vaf-longitudinal") 
input_dir <- file.path(analysis_dir, "input")

# Input files
tmb_genomic_file <- file.path(scratch_dir, "tmb_genomic.tsv")
tumor_descriptor_color_palette_file <- file.path(root_dir, "figures", "palettes", "tumor_descriptor_color_palette.tsv")

# File path to plots directory
plots_dir <-
  file.path(analysis_dir, "plots")
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}

source(paste0(analysis_dir, "/util/function-create-barplot.R"))
source(paste0(root_dir, "/figures/theme.R"))
```

# Read in data and process
```{r read_input_files}
# Read tmb_genomic file generated from step `01-process-data.Rmd`
tmb_genomic <- readr::read_tsv(tmb_genomic_file, guess_max = 100000, show_col_types = FALSE)
tumor_descriptor_color_palette <- readr::read_tsv(tumor_descriptor_color_palette_file, guess_max = 100000, show_col_types = FALSE)

```

# Stacked barplots for each Patient case
```{r create-stacked-barplot}
# Define parameters for function
ylim <- 13000
tmb <- tmb_genomic

fname <- paste0(plots_dir, "/", "Stacked-barplot-tmb-genomic.pdf")
print(fname)
p <- create_stacked_barplot(tmb = tmb, ylim = ylim)
pdf(file = fname, width = 18, height = 8)
print(p)
dev.off()
```

We will exclude any samples with more than 1,000 mutations (hypermutant samples) for all of their `tumor_descriptor` from further analysis in this notebook. There are patient cases with high number of mutations in one timepoint. This m ight result to single timepoints per patient so we will also remove those.

```{r create-stacked-barplot-filter}
tmb_genomic_filter <- tmb_genomic %>%
  filter(!mutation_count >= 1000)  %>%
  unique() %>% 
  arrange(Kids_First_Participant_ID, tumor_descriptor) %>%
  group_by(Kids_First_Participant_ID) %>%
  summarise(tumor_descriptor_sum = str_c(tumor_descriptor, collapse = ";")) %>% 
  filter(!tumor_descriptor_sum %in% c("Diagnosis", "Progressive", "Recurrence")) %>% 
  left_join(tmb_genomic, by = c("Kids_First_Participant_ID", "tumor_descriptor_sum")) %>% 
  mutate(cancer_group_update = ifelse(cancer_group == "High-grade glioma", "High-grade glioma",
                                      ifelse(cancer_group == "Low-grade glioma", "Low-grade glioma", "Other")),
         cancer_group_update = replace_na(cancer_group_update, "Other"))

ylim <- 450
fname_exclude <- paste0(plots_dir, "/", "Stacked-barplot-tmb-genomic-filter.pdf")
print(fname_exclude)
p <- create_stacked_barplot(tmb = tmb_genomic_filter, ylim)
pdf(file = fname_exclude, width = 15, height = 8)
print(p)
dev.off()
```

# Stacked barplots for each Patient case and broad histology
```{r create-stacked-barplot-broad-histology-filter}
ylim <- 450
fname <- paste0(plots_dir, "/", "Stacked-barplot-tmb-genomic-filter-broad-histology.pdf")
print(fname)
p <- create_stacked_barplot_broad_histology(tmb = tmb_genomic_filter, ylim = ylim)
pdf(file = fname, width = 15, height = 10)
print(p)
dev.off()
```

# Stacked barplots for each Patient case and cancer_group_update
We will create one graph for the major two cancer types (High-and Low-grade gliomas) and any other cancer type present.

```{r create-stacked-barplot-cancer-group-update-filter}
cancer_types <- unique(as.character(tmb_genomic_filter$cancer_group_update))
print(cancer_types)

for (i in seq_along(cancer_types)) {
  print(i)
  tmb_genomic_filter_sub <- tmb_genomic_filter %>%
    filter(cancer_group_update == cancer_types [i])
ylim <- 450
fname <- paste0(plots_dir, "/", cancer_types[i], "-", "Stacked-barplot-tmb-genomic-filter-cancer-group-update.pdf")
print(fname)
p <- create_stacked_barplot_cancer_group_update(tmb = tmb_genomic_filter_sub, ylim = ylim, ct_id = cancer_types[i])
pdf(file = fname, width = 15, height = 10)
print(p)
dev.off()
}
```

Since we have multiple biospecimen samples per timepoint and patient case, let's plot these separetely.

# Let's create stacked-barplots per patient sample and split by biospecimen sample
```{r create-stacked-barplot-sample}
samples <- unique(as.character(tmb_genomic$Kids_First_Participant_ID))
print(samples)

samples_include <- samples[!samples %in% c("PT_3CHB9PK5", "PT_6N825561")]

for (i in seq_along(samples_include)) {
  print(i)
  tmb_sub <- tmb_genomic %>%
    filter(Kids_First_Participant_ID == samples_include[i])
  ylim <- 100 # to scale yaxis
  
  # Run function
  fname <- paste0(plots_dir, "/", samples_include[i], "-TMB-barplot.pdf")
  print(fname)
  p <- create_barplot_sample(tmb = tmb_sub,
                             sid = samples_include[i],
                             ylim = ylim)
  pdf(file = fname, width = 5, height = 4)
  print(p)
  dev.off()
}

samples_exclude <- samples[samples %in% c("PT_3CHB9PK5", "PT_6N825561")]

for (i in seq_along(samples_exclude)) {
  print(i)
  tmb_sub <- tmb_genomic %>%
    filter(Kids_First_Participant_ID == samples_exclude[i])
  ylim <- 13000 # to scale yaxis
  
  # Run function
  fname <- paste0(plots_dir, "/", samples_exclude[i], "-TMB-barplot.pdf")
  print(fname)
  p <- create_barplot_sample(tmb = tmb_sub,
                             sid = samples_exclude[i],
                             ylim = ylim)
  pdf(file = fname, width = 5, height = 4)
  print(p)
  dev.off() 
}
```


```{r echo=TRUE}
sessionInfo()
```
