---
title: "Estimation of VAFs of tumors across multiple timepoints for the PBTA Cohort"
author: 'Antonia Chroni <chronia@chop.edu> and Jo Lynne Rokita <rokita@chop.edu> for D3B'
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---


#### Tumor evolution project 

# Background
We are investigating the change of VAFs across multiple timepoints in the PBTA cohort.

### Data used 
In this notebook, we are looking into the v12 histologies file (last updates on May 1st, 2023) and subset to the PBTA cohort.
We use the output files from the "analyses/sample-distribution-analysis/results".

### Method used 


### Usage

This notebook is intended to be run via the command line from the top directory of the repository as follows:

```
Rscript -e "rmarkdown::render('01-process-data.Rmd', clean = TRUE)"
```

# Set up

```{r load-library}
suppressPackageStartupMessages({
  library(tidyverse)
  library(data.table)
  library(flextable)
  library(plyr)
  library(ggplot2)
  library(ggpubr)
  library(ggrepel)
})
```

## Directories and File Inputs/Outputs

```{r set-dir-and-file-names}
# Detect the ".git" folder -- this will be in the project root directory.
# Use this as the root directory to ensure proper sourcing of functions no
# matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
scratch_dir <- file.path(root_dir, "scratch")
data_dir <- file.path(root_dir, "data")

# Inputs
v12 <- file.path(data_dir, "histologies.tsv")
maf <- file.path(data_dir, "snv-consensus-plus-hotspots.maf.tsv.gz")


# create analysis_dir
analysis_dir <- file.path(root_dir, "analyses", "create-corplots")

# File path to input directory
input_dir <- file.path(analysis_dir, "input")

# tmb file
tmb <- file.path(input_dir, "snv-mutation-tmb-coding.tsv")

# The following files were generated from the add-sample-distribution analysis
files_dir <- file.path(root_dir, "analyses", "sample-distribution-analysis", "results")
genomic_assays_matched_time_points <- file.path(files_dir, "genomic_assays_matched_time_points.tsv")


# File path to scratch dir for each paired samples
scratch_dx_dec <-
  file.path(scratch_dir, "dx_dec")
if (!dir.exists(scratch_dx_dec)) {
  dir.create(scratch_dx_dec)
}

scratch_pro_dec <-
  file.path(scratch_dir, "pro_dec")
if (!dir.exists(scratch_pro_dec)) {
  dir.create(scratch_pro_dec)
}

scratch_rec_dec <-
  file.path(scratch_dir, "rec_dec")
if (!dir.exists(scratch_rec_dec)) {
  dir.create(scratch_rec_dec)
}

scratch_dx_pro_dec <-
  file.path(scratch_dir, "dx_pro_dec")
if (!dir.exists(scratch_dx_pro_dec)) {
  dir.create(scratch_dx_pro_dec)
}

scratch_dx_rec_dec <-
  file.path(scratch_dir, "dx_rec_dec")
if (!dir.exists(scratch_dx_rec_dec)) {
  dir.create(scratch_dx_rec_dec)
}

scratch_pro_rec_dec <-
  file.path(scratch_dir, "pro_rec_dec")
if (!dir.exists(scratch_pro_rec_dec)) {
  dir.create(scratch_pro_rec_dec)
}
```

## Load and Process data
We will also Calculate VAFs per each Kids_First_Biospecimen_ID.

```{r load-inputs-please-wait}
# pbta cohort
pbta <- readr::read_tsv(v12, guess_max = 100000, show_col_types = FALSE) %>%
  filter(cohort == "PBTA",
         !is.na(pathology_diagnosis),
         !composition %in% c("Derived Cell Line", "PDX"),
         !experimental_strategy %in% c("Methylation", "Targeted Sequencing")) 

## Read MAF file
snv <- data.table::fread(maf, data.table = F) %>%
  filter(Tumor_Sample_Barcode %in% pbta$Kids_First_Biospecimen_ID) %>%
  dplyr::rename(Kids_First_Biospecimen_ID = Tumor_Sample_Barcode) %>% # change the column name of the biospecimen column to match the column name from the histologies files
  dplyr::mutate(VAF = t_alt_count / (t_ref_count + t_alt_count)) %>% # calculate VAF
  select(Kids_First_Biospecimen_ID, Hugo_Symbol, Chromosome, Start_Position, Variant_Classification, VAF, HGVSc, HGVSp, HGVSp_Short) 

## Read in genomic_assays_matched_time_points file and get the list of patients
genomic_assays_matched_time_points_list <- readr::read_tsv(genomic_assays_matched_time_points, guess_max = 100000, show_col_types = FALSE) %>%
                                      subset(select = c("Kids_First_Participant_ID", "descriptors"))
  
# Read file with TMB information
tmb <- readr::read_tsv(tmb, guess_max = 100000, show_col_types = FALSE)
```

# Select patients with genomic assays

```{r echo=TRUE}
# We will look only into samples with genomic assays
# We will use the list fo the patients from the "genomic_assays_matched_time_points_list" and merge to the pbta table
# We need to count how many tumor samples we have per patient/time point, if any
# We need to create a column to do that: match_id_multiple_samples
genomic_assays_matched_time_points_list_merge <- genomic_assays_matched_time_points_list %>% 
  left_join(pbta, by=c('Kids_First_Participant_ID')) %>%
  filter(!(experimental_strategy == "RNA-Seq")) %>%
  mutate(match_id_multiple_samples = paste(Kids_First_Participant_ID, sample_id, composition, sep = "_")) %>%
  mutate(tumor_descriptor = case_when(grepl("Primary Tumor", tumor_descriptor) ~ "Diagnosis",
                                 grepl("Initial CNS Tumor", tumor_descriptor) ~ "Diagnosis",
                                 grepl('Progressive Disease Post-Mortem', tumor_descriptor) ~ 'Deceased', 
                                 TRUE ~ tumor_descriptor)) %>%
  mutate(Deceased = case_when(grepl("Deceased", descriptors) ~ "Deceased")) %>%
  filter(Deceased == "Deceased") 
```

# Autopsy samples 
We will focus on patient cases containing autopsy samples and save these maf files separately.
We will do this for different pairs.


```{r maf_files_Deceased}
#let us filter by Deceased samples
maf_files_Deceased <- genomic_assays_matched_time_points_list_merge %>% 
  left_join(snv, by=c('Kids_First_Biospecimen_ID')) %>%
  filter(!is.na(Kids_First_Participant_ID)) %>%
  filter(!is.na(VAF))
```

## Let's save the maf files per each category

```{r save-maf-files}
##########################################################################################
# Storing all Dx-Deceased Sample pairs in a list so each file can be processed iteratively
data <- maf_files_Deceased %>% 
  mutate(data = case_when(grepl("Deceased, Diagnosis", descriptors) ~ "dx_dec")) %>%
  filter(data == "dx_dec")

setwd(scratch_dx_dec)
# we will split maf data by the "Kids_First_Participant_ID" column
data %>% 
  group_split(Kids_First_Participant_ID) %>% 
  walk(~write_csv(.x, paste0(.x$Kids_First_Participant_ID[1], "-vaf.csv")))
  
#sptdf <- split(data, data$Kids_First_Participant_ID)
#lapply(sptdf, function(DF){
#  outfile <- as.character(unique(DF[["Kids_First_Participant_ID"]]))
#  outfile <- paste0(outfile, "-vaf.txt", sep = "\t")
#  write.table(file.path(DF, 
#              file = outfile,
#              path = scratch_dx_dec,
#              row.names = FALSE,
#              quote = FALSE))
#})

#walk(~write_csv(.x, paste0((path = scratch_dx_dec), .x$Kids_First_Participant_ID[1], "-vaf.csv")))
#write_table(file.path(paste0(scratch_dx_dec, .x$Kids_First_Participant_ID[1], "-vaf.txt", sep = "\t")))
                     
                    
##########################################################################################
# Storing all pro_dec Sample pairs in a list so each file can be processed iteratively
data <- maf_files_Deceased %>% 
  filter(descriptors %in% c("Deceased, Progressive", "Deceased, Progressive, Progressive"))

setwd(scratch_pro_dec)
# we will split maf data by the "Kids_First_Participant_ID" column
data %>% 
  group_split(Kids_First_Participant_ID) %>% 
  walk(~write_csv(.x, paste0(.x$Kids_First_Participant_ID[1], "-vaf.csv")))

##########################################################################################
# Storing all Deceased, Recurrence Sample pairs in a list so each file can be processed iteratively
data <- maf_files_Deceased %>% 
  filter(descriptors == "Deceased, Recurrence")

setwd(scratch_rec_dec)
# we will split maf data by the "Kids_First_Participant_ID" column
data %>% 
  group_split(Kids_First_Participant_ID) %>% 
  walk(~write_csv(.x, paste0(.x$Kids_First_Participant_ID[1], "-vaf.csv")))

##########################################################################################  
# Storing all dx_pro_dec Sample pairs in a list so each file can be processed iteratively
data <- maf_files_Deceased %>% 
        mutate(data = case_when(grepl("Deceased, Diagnosis, Diagnosis, Progressive, Progressive", descriptors) ~ "dx_pro_dec")) %>%
 filter(data == "dx_pro_dec")

setwd(scratch_dx_pro_dec)
# we will split maf data by the "Kids_First_Participant_ID" column
data %>% 
  group_split(Kids_First_Participant_ID) %>% 
  walk(~write_csv(.x, paste0(.x$Kids_First_Participant_ID[1], "-vaf.csv")))

##########################################################################################
# Storing all dx_rec_dec Sample pairs in a list so each file can be processed iteratively
data <- maf_files_Deceased %>% 
  mutate(data = case_when(grepl("Deceased, Diagnosis, Recurrence", descriptors) ~ "dx_rec_dec")) %>%
  filter(data == "dx_rec_dec")

setwd(scratch_dx_rec_dec)
# we will split maf data by the "Kids_First_Participant_ID" column
data %>% 
  group_split(Kids_First_Participant_ID) %>% 
  walk(~write_csv(.x, paste0(.x$Kids_First_Participant_ID[1], "-vaf.csv")))

##########################################################################################
# Storing all pro_rec_dec Sample pairs in a list so each file can be processed iteratively
data <- maf_files_Deceased %>% 
 mutate(data = case_when(grepl("Deceased, Progressive, Recurrence", descriptors) ~ "pro_rec_dec")) %>%
  filter(data == "pro_rec_dec")

setwd(scratch_pro_rec_dec)
# we will split maf data by the "Kids_First_Participant_ID" column
data %>% 
  group_split(Kids_First_Participant_ID) %>% 
  walk(~write_csv(.x, paste0(.x$Kids_First_Participant_ID[1], "-vaf.csv")))
```


```{r echo=TRUE}
sessionInfo()
```
  