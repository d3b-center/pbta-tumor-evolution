---
title: "Inference of subclonal architecture of tumors across multiple timepoints for the PBTA Cohort"
author: 'Antonia Chroni <chronia@chop.edu> for D3B'
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---

# Set up

```{r sload-library}
suppressPackageStartupMessages({
  library(tidyverse)
 # library(data.table)
  #library(R.utils)
 # library(clonevol)
 # library(devtools)
 # library(purrr)
 # library(flextable)
 # library(plyr)
})
```

# Directories and File Inputs/Outputs

```{r set-dir-and-file-names}
# Detect the ".git" folder -- this will be in the project root directory
# Use this as the root directory to ensure proper sourcing of functions 
# no matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "tumor-clone-inference")
input_dir <- file.path(analysis_dir, "input")
data_dir <- file.path(root_dir, "data")
files_dir <- file.path(root_dir, "analyses", "sample-distribution-analysis", "results")
maf_files_dir <- file.path(root_dir, "analyses", "tmb-vaf-longitudinal", "results")

# Input files
pbta_file <- file.path(files_dir, "pbta.tsv") # file from add-sample-distribution module
maf_file <- file.path(maf_files_dir, "maf.tsv")
genomic_paired_file <- file.path(files_dir, "genomic_assays_matched_time_points.tsv") # file from add-sample-distribution module

# File path to results directory
results_dir <-
  file.path(analysis_dir, "results", "CloneFinder_input")
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

source(paste0(analysis_dir, "/util/function-create-df.R"))
```

# Load data

```{r load-inputs-please-wait}
maf_df <- readr::read_tsv(maf_file, guess_max = 100000, show_col_types = FALSE) %>% 
  dplyr::rename("Chr" = "Chromosome", 
                "Position" = "Start_Position",
                "Wild" = "Reference_Allele",
                "Mut" = "Tumor_Seq_Allele2",
                "XX:ref" = "t_ref_count", 
                "XX:alt" = "t_alt_count") # change names to match input requirements for Clonefinder

pbta_df <- readr::read_tsv(pbta_file, guess_max = 100000, show_col_types = FALSE) %>% 
  filter(!experimental_strategy == "RNA-Seq")

genomic_paired_df <- readr::read_tsv(genomic_paired_file, guess_max = 100000, show_col_types = FALSE) %>% 
  select(!c(cancer_group, experimental_strategy)) %>% 
  left_join(pbta_df, by = c("Kids_First_Participant_ID")) %>% 
  dplyr::mutate(cg_id_kids = paste(cg_id, Kids_First_Participant_ID, sep = "_"),
         cg_id_kids = str_replace(cg_id_kids, "/", "_"),
         td_bs_id = paste(tumor_descriptor, Kids_First_Biospecimen_ID, sep = "_"))

df <- genomic_paired_df %>% 
  left_join(maf_df, by = c("Kids_First_Biospecimen_ID")) %>% 
  mutate(mut_id = paste(Chr, Position, Wild, Mut, sep = "_"))

df_samples <- print(length(unique(df$cg_id_kids)))
```

# Process Data for CloneFinder

We need to generate the input files for CloneFinder according to the method's template. 
The method requires at least 2 samples per tumor site (multiregional sampling per anatomical site).
Here, we will consider kids samples with more than 2 timepoints with one or more biospecimens. 
We will compare later differences in samples with single vs multiple biospecimens.


```{r df-cg-id-kids}
# Save results by cg_id_kids
cg_id_kids_names <- unique(as.character(df$cg_id_kids))
cg_id_kids_names <- sort(cg_id_kids_names, decreasing = FALSE)
print(cg_id_kids_names)

# Loop through cg_sum
for (x in seq_along(cg_id_kids_names)){
  print(x)

  df_sub <- df %>%
    filter(cg_id_kids == cg_id_kids_names[x]) %>% 
  select("cg_id_kids", "td_bs_id", "mut_id", "Chr", "Position", "Wild", "Mut", "XX:ref", "XX:alt")
 
  # We will define samples
  td_bs_id_names <- unique(as.character(df_sub$td_bs_id))
  print(td_bs_id_names)
  
  # Create empty list for df
  df_list <- list() 
  
  # Run loop for each td_bs_id_names
  for (i in seq_along(td_bs_id_names)) {
    print(i)
   
    td_bs_df <- df_sub %>%
      filter(td_bs_id == td_bs_id_names[i])
    
    # Run function 
    m <- create_df(df = td_bs_df, 
                   sample_id = td_bs_id_names[i],
                   cg_kid = cg_id_kids_names[x])
  
    # Assign name to df and store all df in list
    df_name <- paste(cg_id_kids_names[x], td_bs_id_names[i], sep = "-")
    df <- assign(df_name, m)
    df_list[[df_name]] <- df
    
    # Merge all df per `cg_kids_id`
    # Assign name to all_df
    name <- paste(cg_id_kids_names[x])

    #library(powerjoin)
    cg_kids_df <- power_full_join(df_list, by = c("cg_id_kids", "mut_id", "Chr", "Position", "Wild", "Mut")) %>% 
      replace(is.na(.), 0) %>% 
      write_tsv(file.path(results_dir, paste0(name, ".txt")))

    }
}
```


```{r}
sessionInfo()
```