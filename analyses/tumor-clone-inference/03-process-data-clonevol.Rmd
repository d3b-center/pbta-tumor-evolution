---
title: "Prepare input data for clonevol"
author: 'Antonia Chroni <chronia@chop.edu> for D3B'
date: "2023"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
---

# Background

[ClonEvol](https://github.com/hdng/clonevol) is a package for clonal ordering and clonal evolution visualization. It uses the clustering of heterozygous variants identified using other tools as input to infer consensus clonal evolution trees and estimate the cancer cell fraction (also called clonal frequency) of the clones in individual samples. ClonEvol can deal with statistical uncertainty and error in sequencing and data analysis that may distort the cellular prevalence estimate of individual variants.


# Set up

```{r load-library}
suppressPackageStartupMessages({
  library(tidyverse)
  #library(readxl)
})
```

# Directories and File Inputs/Outputs

```{r set-dir-and-file-names}
# Detect the ".git" folder -- this will be in the project root directory
# Use this as the root directory to ensure proper sourcing of functions 
# no matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "tumor-clone-inference")
results_dir <- file.path(analysis_dir, "results")
input_dir <- file.path(results_dir, "pyclone-vi-output", "PT_Z4BF2NSB40")


# Input files
nautilus_dec_file <- file.path(results_dir, "nautilus_dec.tsv") 
pyclonevi_output_file <- file.path(input_dir, "PT_Z4BF2NSB40.tsv") 


# File path to input directory
clonevol_input_dir <-
  file.path(analysis_dir, "results", "clonevol-input")
if (!dir.exists(clonevol_input_dir)) {
  dir.create(clonevol_input_dir)
}
```

# Load and process data

```{r load-process-inputs}
PT_Z4BF2NSB_df <- readr::read_tsv(nautilus_dec_file, guess_max = 100000, show_col_types = FALSE) %>%
  filter(Kids_First_Participant_ID == "PT_Z4BF2NSB") %>% 
  select(Kids_First_Participant_ID, Kids_First_Biospecimen_ID, cg_id, tumor_descriptor,
         sample_id, t_ref_count, t_alt_count, mutation_id,
         tumor_fraction, VAF, Hugo_Symbol, CCF) 


cluster_df <- readr::read_tsv(pyclonevi_output_file, guess_max = 100000, show_col_types = FALSE) %>% 
  # change names to match input requirements
  dplyr::rename("cluster" = "cluster_id") %>% 
  select(sample_id, cluster) #%>% 
  # pyclone-vi starts numbering of clones from `0`
  # this will cause an error for clonevol when trying to subset
  # in the `plot.variant.clusters`
  # as in R cluster[0] = NULL and hence class(cluster[[0]]) is non numeric
  # https://stackoverflow.com/questions/72110405/what-is-in-index-0-of-an-r-list-if-they-usually-start-with-index-1
  
  # NEED TO MAKE IT REPRODUCIBLE THIS for a number of clusters!!
  #dplyr::mutate(#sample_id = str_replace(sample_id, ":", "_"),
   #             cluster = as.numeric(cluster), 
   #             cluster = case_when(grepl("0", cluster) ~ "1")) #,
                                    #grepl("Deceased_BS_2T4EJ6KN", sample_id) ~ "2")) %>% 
  #as.data.frame()


#cluster_df$cluster <- as.numeric(as.character(cluster_df$cluster))
#class(cluster_df$cluster[[1]])

clonevol_df <- PT_Z4BF2NSB_df %>% 
  select(Kids_First_Participant_ID, sample_id, t_ref_count, t_alt_count,
         VAF, Hugo_Symbol, CCF) %>% 
  left_join(cluster_df) %>% 
  
  # change names to match input requirements
  dplyr::rename("ref.count" = "t_ref_count", 
                "var.count" = "t_alt_count",
                "vaf" = "VAF",
                "ccf" = "CCF",
                "gene" = "Hugo_Symbol") %>% 
  unique() %>% 
  #as.numeric(as.character(cluster)) %>% 
  
  # TEST
  dplyr::mutate(cluster = case_when(grepl("Deceased:BS_2T4EJ6KN", sample_id) ~ "2",
                                    TRUE ~ "1"),
                ccf = (ccf*100)) #,
               #unique_id = paste(sample_id, ref.count, sep = ":"))  


# to make a loop for each `Kids_First_Participant_ID`
# for now it's one sample
# make long table

df <- clonevol_df %>%
  #filter(td_bs_id == sample_id) %>%
  pivot_wider(names_from = "sample_id", values_from = c("ref.count", "var.count", "vaf", "ccf"), values_fn = list) %>% 
  mutate_all( ~replace(., lengths(.)==0, NA)) %>%
  as.data.frame() %>% 
  replace(is.na(.), 0) %>% 
  mutate(cluster = as.numeric(cluster))

class(df$cluster)
```


```{r}
sessionInfo()
```


